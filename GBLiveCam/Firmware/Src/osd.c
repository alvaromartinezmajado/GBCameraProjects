#include "main.h"
#include "osd.h"

static const uint8_t osd_font[16*4*18] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    //
	0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0x00, 0x00, 0x0C, 0x03, 0x00,    // !
	0x73, 0x9C, 0xE2, 0x10, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    // "
	0x03, 0x0C, 0xC3, 0x3C, 0xFF, 0xFF, 0x3C, 0xC3, 0x30, 0xCF, 0x3F, 0xFF, 0xCF, 0x30, 0xCC, 0x30, 0x00, 0x00,    // #
	0x0C, 0x0F, 0xC7, 0xFB, 0xB7, 0xCC, 0xFB, 0x07, 0xF0, 0xFE, 0x0D, 0xF3, 0x3E, 0xDD, 0xFE, 0x3F, 0x03, 0x00,    // $
	0x70, 0xFE, 0x3D, 0x8F, 0x67, 0xFB, 0x9D, 0xC0, 0xE0, 0x70, 0x3B, 0x9D, 0xFE, 0x6F, 0x1B, 0xC7, 0xF0, 0xE0,    // %
	0x1C, 0x0F, 0x87, 0x71, 0x8C, 0x63, 0x0D, 0x83, 0xE1, 0xF0, 0xEE, 0xF1, 0xFC, 0x3B, 0x8E, 0x7F, 0xCF, 0xB0,    // &
	0x0E, 0x03, 0x80, 0x40, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    // '
	0x06, 0x03, 0x01, 0x80, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0x60, 0x0C, 0x01, 0x80,    // (
	0x18, 0x03, 0x00, 0x60, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x18, 0x0C, 0x06, 0x00,    // )
	0x0C, 0x1B, 0x63, 0xF0, 0x78, 0x3F, 0x1B, 0x60, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    // *
	0x00, 0x00, 0x00, 0x00, 0x30, 0x0C, 0x03, 0x07, 0xF9, 0xFE, 0x0C, 0x03, 0x00, 0xC0, 0x00, 0x00, 0x00, 0x00,    // +
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x18, 0x0C, 0x06, 0x00,    // ,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xF9, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    // -
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x03, 0x00,    // .
	0x00, 0xC0, 0x30, 0x0C, 0x07, 0x03, 0x81, 0xC0, 0xE0, 0x70, 0x38, 0x1C, 0x0E, 0x03, 0x00, 0xC0, 0x30, 0x00,    // /
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0xC3, 0xF1, 0xFC, 0xEF, 0x73, 0xF8, 0xFC, 0x3C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // 0
	0x0C, 0x07, 0x03, 0xC0, 0xF0, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x3F, 0x0F, 0xC0,    // 1
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0x00, 0xC0, 0x73, 0xF9, 0xFC, 0xE0, 0x30, 0x0C, 0x03, 0x00, 0xFF, 0xFF, 0xF0,    // 2
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0x00, 0xC0, 0x70, 0xF8, 0x3E, 0x01, 0xC0, 0x3C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // 3
	0x03, 0x01, 0xC0, 0xF0, 0x7C, 0x3B, 0x1C, 0xCE, 0x33, 0x0C, 0xFF, 0xFF, 0xF0, 0x30, 0x0C, 0x03, 0x00, 0xC0,    // 4
	0xFF, 0xFF, 0xFC, 0x03, 0x00, 0xFF, 0x3F, 0xE0, 0x1C, 0x03, 0x00, 0xC0, 0x3C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // 5
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0xC0, 0x30, 0x0F, 0xF3, 0xFE, 0xC1, 0xF0, 0x3C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // 6
	0xFF, 0xFF, 0xF0, 0x0C, 0x03, 0x01, 0xC0, 0xE0, 0x70, 0x38, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00,    // 7
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0xC0, 0xF8, 0x77, 0xF9, 0xFE, 0xE1, 0xF0, 0x3C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // 8
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0xC0, 0xF8, 0x37, 0xFC, 0xFF, 0x00, 0xC0, 0x3C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // 9
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0xC0, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x30, 0x00, 0x00, 0x00,    // :
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0xC0, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x30, 0x18, 0x0C, 0x00,    // ;
	0x00, 0x00, 0xC0, 0x70, 0x38, 0x1C, 0x0E, 0x07, 0x01, 0xC0, 0x38, 0x07, 0x00, 0xE0, 0x1C, 0x03, 0x00, 0x00,    // <
	0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x9F, 0xE0, 0x00, 0x00, 0x00, 0x1F, 0xE7, 0xF8, 0x00, 0x00, 0x00, 0x00,    // =
	0x00, 0x0C, 0x03, 0x80, 0x70, 0x0E, 0x01, 0xC0, 0x38, 0x0E, 0x07, 0x03, 0x81, 0xC0, 0xE0, 0x30, 0x00, 0x00,    // >
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0x00, 0xC0, 0x70, 0x38, 0x1C, 0x0E, 0x03, 0x00, 0x00, 0x00, 0x0C, 0x03, 0x00,    // ?
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0xCC, 0xF7, 0xBD, 0x6F, 0x5B, 0xD7, 0xF3, 0xEC, 0x03, 0x87, 0x7F, 0x8F, 0xC0,    // @
	0x0C, 0x07, 0x83, 0xF1, 0xCE, 0xE1, 0xF0, 0x3C, 0x0F, 0x03, 0xFF, 0xFF, 0xFC, 0x0F, 0x03, 0xC0, 0xF0, 0x30,    // A
	0xFF, 0x3F, 0xEC, 0x1F, 0x03, 0xC0, 0xF0, 0x7F, 0xFB, 0xFE, 0xC1, 0xF0, 0x3C, 0x0F, 0x07, 0xFF, 0xBF, 0xC0,    // B
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // C
	0xFF, 0x3F, 0xEC, 0x1F, 0x03, 0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF0, 0x3C, 0x0F, 0x07, 0xFF, 0xBF, 0xC0,    // D
	0xFF, 0xFF, 0xFC, 0x03, 0x00, 0xC0, 0x30, 0x0F, 0xF3, 0xFC, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xFF, 0xFF, 0xF0,    // E
	0xFF, 0xFF, 0xFC, 0x03, 0x00, 0xC0, 0x30, 0x0F, 0xF3, 0xFC, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x00,    // F
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0xC0, 0x30, 0x0C, 0x7F, 0x1F, 0xC0, 0xF0, 0x3C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // G
	0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF0, 0x3F, 0xFF, 0xFF, 0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF0, 0x30,    // H
	0x3F, 0x0F, 0xC0, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x3F, 0x0F, 0xC0,    // I
	0x0F, 0xC3, 0xF0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xCC, 0x33, 0x9C, 0x7E, 0x0F, 0x00,    // J
	0xC0, 0xF0, 0x7C, 0x3B, 0x1C, 0xCE, 0x37, 0x0F, 0x83, 0xE0, 0xDC, 0x33, 0x8C, 0x73, 0x0E, 0xC1, 0xF0, 0x30,    // K
	0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xFF, 0xFF, 0xF0,    // L
	0xC0, 0xF0, 0x3E, 0x1F, 0xCF, 0xFF, 0xF7, 0xBC, 0xCF, 0x33, 0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF0, 0x30,    // M
	0xC0, 0xF0, 0x3C, 0x0F, 0x83, 0xF0, 0xFE, 0x3D, 0xCF, 0x3B, 0xC7, 0xF0, 0xFC, 0x1F, 0x03, 0xC0, 0xF0, 0x30,    // N
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF0, 0x3C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // O
	0xFF, 0x3F, 0xEC, 0x1F, 0x03, 0xC0, 0xF0, 0x7F, 0xFB, 0xFC, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x00,    // P
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xCC, 0xF3, 0xBC, 0x7F, 0x8E, 0x7F, 0xCF, 0x30,    // Q
	0xFF, 0x3F, 0xEC, 0x1F, 0x03, 0xC0, 0xF0, 0x7F, 0xFB, 0xFC, 0xDC, 0x33, 0x8C, 0x73, 0x0E, 0xC1, 0xF0, 0x30,    // R
	0x3F, 0x1F, 0xEE, 0x1F, 0x03, 0xC0, 0x38, 0x07, 0xF0, 0xFE, 0x01, 0xC0, 0x3C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // S
	0xFF, 0xFF, 0xF0, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00,    // T
	0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF0, 0x3C, 0x0F, 0x87, 0x7F, 0x8F, 0xC0,    // U
	0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF8, 0x77, 0x38, 0xFC, 0x1E, 0x03, 0x00,    // V
	0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF0, 0x3C, 0xCF, 0x33, 0xCC, 0xF3, 0x3C, 0xCF, 0xFF, 0x7F, 0x8C, 0xC0,    // W
	0xC0, 0xF0, 0x3C, 0x0F, 0x87, 0x73, 0x8F, 0xC1, 0xE0, 0x78, 0x3F, 0x1C, 0xEE, 0x1F, 0x03, 0xC0, 0xF0, 0x30,    // X
	0xC0, 0xF0, 0x3C, 0x0F, 0x03, 0xC0, 0xF8, 0x77, 0x38, 0xFC, 0x1E, 0x03, 0x00, 0xC0, 0x30, 0x0C, 0x03, 0x00,    // Y
	0xFF, 0xFF, 0xF0, 0x0C, 0x07, 0x03, 0x81, 0xC0, 0xE0, 0x70, 0x38, 0x1C, 0x0E, 0x03, 0x00, 0xFF, 0xFF, 0xF0,    // Z
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    // [
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    //
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    //
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    //
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,    //
};

static char ascii2hex(uint32_t v) {
	uint32_t b = v & 15;

	if (b > 9)
		return 'A' + b - 10;
	else
		return '0' + b;
}

void OSD_write_value(const uint8_t px, const uint8_t py, uint8_t* buffer, const char letter, uint32_t value, const uint32_t digits) {
	uint32_t c;
	char str_buf[10] = { 0 };

	str_buf[0] = letter;
	for (c = 0; c < digits; c++) {
		str_buf[digits - c] = ascii2hex(value);
		value >>= 4;
	}
	OSD_write(px, py, buffer, str_buf);
}

void OSD_write(const uint8_t px, const uint8_t py, uint8_t* buffer, char* txt) {
	uint32_t x, y, cx = px;
	uint8_t sr = 0;
	char c;

	while ((c = *txt++)) {
		x = 0;
		y = 0;
		c -= 32;
		for (uint32_t b = 0; b < (10 * 14); b++) {
			if (!(b & 7))
				sr = osd_font[(c * 18) + (b >> 3)];	// Load 8 pixels

			uint32_t px_addr = cx + x + ((py + y) * 128);

			if (sr & 0x80)
				buffer[px_addr >> 2] |= (3 << ((3 - (px_addr & 3)) * 2));

			sr <<= 1;

			if (x == 9) {
				x = 0;
				y++;
			} else
				x++;
		}
		cx += (10 + 1);
	}
}

void OSD_write_nocam(uint8_t* buffer) {
	uint32_t x, y;

	OSD_write(37, 16*1, buffer, "NO GB");
	OSD_write(31, 16*2, buffer, "CAMERA");
	OSD_write(20, 16*3, buffer, "ATTACHED");
	OSD_write(53, 16*4, buffer, ":(");

	// Palette boxes
	for (y = 0; y < 16; y++) {
		for (x = 0; x < 16; x++) {
			buffer[2568 + x + (y << 5)] = (x >> 2) * 0x55;
		}
	}
}
